stages:
- conflict

generate_and_push_conflict:
  stage: conflict
  only:
  - development # запускаем только на ветке development
  tags:
  - runner # убери этот блок, если у раннера нет тега
  script: |
    $ErrorActionPreference = 'Stop'

    git config --global user.name  'hook-bot'
    git config --global user.email 'hook-bot@example.com'

    $gh   = "https://$env:GITHUB_TOKEN@github.com/akaptelinin/gitlab-github-mirror-test.git"
    $work = Join-Path $PWD 'temp_repo'

    if (Test-Path $work) { Remove-Item $work -Recurse -Force }
    New-Item -ItemType Directory -Path $work | Out-Null
    Set-Location $work

    git init
    git remote add origin $gh
    git fetch origin development
    git checkout -b development origin/development

    if (-not (Test-Path dev_conflict.txt)) {
      & "$CI_PROJECT_DIR\generate_dev_conflict.ps1" dev_conflict.txt
      git add dev_conflict.txt
      $now = (Get-Date).ToString('dd MMM yyyy HH:mm').ToLower()
      git commit -m "auto-conflict file generated. $now"
    } else {
      Write-Host 'dev_conflict.txt already exists, skip generation'
    }

    # пытаемся запушить; если не fast‑forward — раннер падает
    git push origin HEAD:development
    if ($LASTEXITCODE -ne 0) {
      Write-Host 'push failed (branch updated on remote), aborting job'
      exit 1
    }
